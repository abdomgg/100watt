<?xml version="1.0" encoding="utf-8"?>
<odoo>

  <!-- 
    CLEANUP: Delete old rules that may conflict.
    These were from previous versions of this module.
  -->
  <delete model="ir.rule" search="[('name', 'ilike', 'Users: Sales/Leads read self')]"/>
  <delete model="ir.rule" search="[('name', 'ilike', 'Users: Team Leaders read all internal')]"/>

  <!-- Admin: read all users -->
  <record id="rule_res_users_admin_all" model="ir.rule">
    <field name="name">Users: Admin can read all</field>
    <field name="model_id" ref="base.model_res_users"/>
    <field name="domain_force">[(1,'=',1)]</field>
    <field name="groups" eval="[(4, ref('base.group_system'))]"/>
    <field name="perm_read" eval="True"/>
    <field name="perm_write" eval="True"/>
    <field name="perm_create" eval="True"/>
    <field name="perm_unlink" eval="True"/>
    <field name="global" eval="False"/>
  </record>

  <!-- Team Leader: reads ALL users (no restrictions) - MUST come before salesperson rule -->
  <record id="rule_res_users_team_leader_all" model="ir.rule">
    <field name="name">Users: Team Leaders read all users</field>
    <field name="model_id" ref="base.model_res_users"/>
    <field name="domain_force">[(1, '=', 1)]</field>
    <field name="groups" eval="[(4, ref('sales_team.group_sale_salesman_all_leads'))]"/>
    <field name="perm_read" eval="True"/>
    <field name="perm_write" eval="False"/>
    <field name="perm_create" eval="False"/>
    <field name="perm_unlink" eval="False"/>
    <field name="global" eval="False"/>
  </record>

  <!-- Salesperson: reads self + users in their team -->
  <record id="rule_res_users_salesperson_self" model="ir.rule">
    <field name="name">Users: Salesperson reads self and team members</field>
    <field name="model_id" ref="base.model_res_users"/>
    <field name="domain_force">[
      '|',
        ('id', '=', user.id),
        ('sale_team_id', '=', user.sale_team_id.id)
    ]</field>
    <field name="groups" eval="[(4, ref('sales_team.group_sale_salesman'))]"/>
    <field name="perm_read" eval="True"/>
    <field name="perm_write" eval="False"/>
    <field name="perm_create" eval="False"/>
    <field name="perm_unlink" eval="False"/>
    <field name="global" eval="False"/>
  </record>

</odoo>
